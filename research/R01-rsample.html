<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="FdR">
<meta name="dcterms.date" content="2023-02-12">

<title>Understanding Rsample</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="R01-rsample_files/libs/clipboard/clipboard.min.js"></script>
<script src="R01-rsample_files/libs/quarto-html/quarto.js"></script>
<script src="R01-rsample_files/libs/quarto-html/popper.min.js"></script>
<script src="R01-rsample_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="R01-rsample_files/libs/quarto-html/anchor.min.js"></script>
<link href="R01-rsample_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="R01-rsample_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="R01-rsample_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="R01-rsample_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="R01-rsample_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Understanding Rsample</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>FdR </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 12, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="getting-to-know-cross-validation-with-time-series" class="level1">
<h1>Getting to know Cross-validation with time-series</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>When doing cross-validation, we usually tend to have a training set, a validation set and then finally a testing set. We need a testing set because whatever algorithm we have used, that algorithm has been fine-tuned to increase ‘success’ (however you measure it in your problem) on the validation set. Hence, you have the best possible outcomes, but it doesn’t mean it translates further to an ‘accurate’ forecasting (again, however ways you measure that in your problem). This is why we save some observations (the latest one), to really see if our model have any predictive power.</p>
<p>What I am looking for here is to keep the last 6 months of data + look ahead time (7 weeks in my case) for testing. So I will keep 8 months worth of data for testing. The rest, I would like to break it into a 80-20 training / validation sets.</p>
<p>Problem to solve: how to automate the above training/validation/test splits.</p>
<p>This require a deeper dive into how the <strong>rsample</strong> library works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>the_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>()</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>ticker <span class="ot">&lt;-</span> <span class="st">'SPY'</span> </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># rsample assume the data are already ordered (oldest to newest)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>create_cv_data <span class="ot">&lt;-</span> <span class="cf">function</span>(ticker){</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(the_path, <span class="st">"/data_stock_fmpr/"</span>, ticker, <span class="st">".csv"</span>), </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">index =</span> date, <span class="at">adjusted =</span> adjClose) <span class="sc">|&gt;</span> </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(index) <span class="sc">|&gt;</span> </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(index <span class="sc">&lt;</span> <span class="fu">today</span>()  <span class="sc">-</span> <span class="dv">8</span><span class="sc">*</span><span class="dv">21</span>) <span class="co"># removing the last 8 months of data for testing</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">create_cv_data</span>(ticker) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-rolling_origin-works" class="level2">
<h2 class="anchored" data-anchor-id="how-rolling_origin-works">How rolling_origin() works</h2>
<p>First, we create time_slices using the <strong>rolling_origin()</strong> function from the <em>rsample</em> package.</p>
<p>The arguments used by <em>rolling_oring()</em> are</p>
<ul>
<li>initial: number of observations (time units) used for a training sample</li>
<li>assess: number of observations (time units) used for the associated validation sample</li>
<li>skip: how many observations (time units, days here) we jump between each training sample. Skip is just between training samples.<br>
</li>
<li>lag: if we want a lag (a certain amount of days) between the training and validation samples(). This is suggested to avoid any auto-correlation issues. We are going to put a month of trading in between the training samples and validation samples</li>
</ul>
<p>What took me a while to understand is the relationship between the <strong>assess</strong> and <strong>lag</strong> arguments. So here is how I am currently understanding it:</p>
<ul>
<li>lag is based on assess. It skips unit of times from the assess sample<br>
</li>
<li>and assess starts right after the initial samples</li>
<li>the size of the validation sample = assess + lag<br>
</li>
<li>Now, lag has to be negative for us validation = 10, which 31 (assess) - 21 (lag)</li>
</ul>
<p>The output of that function is a tibble with 2 columns.</p>
<ul>
<li>splits: a <strong>binary split</strong> of ‘list’ type</li>
<li>id: the slice ID (characters) of ‘character’ type</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>time_slices <span class="ot">&lt;-</span> <span class="fu">rolling_origin</span>(df, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">initial =</span> <span class="dv">1000</span>, <span class="at">assess =</span> <span class="dv">31</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">lag =</span> <span class="sc">-</span><span class="dv">21</span>, <span class="at">skip =</span> <span class="dv">63</span>, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cumulative =</span> <span class="cn">FALSE</span>) </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(time_slices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 73
Columns: 2
$ splits &lt;list&gt; [&lt;rof_split[1000 x 10 x 5662 x 2]&gt;], [&lt;rof_split[1000 x 10 x 5…
$ id     &lt;chr&gt; "Slice01", "Slice02", "Slice03", "Slice04", "Slice05", "Slice06…</code></pre>
</div>
</div>
</section>
<section id="extracting-training-and-testing-samples" class="level2">
<h2 class="anchored" data-anchor-id="extracting-training-and-testing-samples">Extracting training and testing samples</h2>
<p>Next step is to extract the training and testing set from the split. We use the 2 functions <strong>training()</strong> and <strong>testing()</strong> for extraction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the use of map() in mutate() is for the training() and testing() functions from the rsample package.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># these 2 functions extract the data from the splits made by rolling_origin()</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>ts_df <span class="ot">&lt;-</span> time_slices <span class="sc">|&gt;</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">train =</span> <span class="fu">map</span>(splits, training), </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">validation =</span> <span class="fu">map</span>(splits, testing)) </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(ts_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 73
Columns: 4
$ splits     &lt;list&gt; [&lt;rof_split[1000 x 10 x 5662 x 2]&gt;], [&lt;rof_split[1000 x 10…
$ id         &lt;chr&gt; "Slice01", "Slice02", "Slice03", "Slice04", "Slice05", "Sli…
$ train      &lt;list&gt; [&lt;tbl_df[1000 x 2]&gt;], [&lt;tbl_df[1000 x 2]&gt;], [&lt;tbl_df[1000 …
$ validation &lt;list&gt; [&lt;tbl_df[10 x 2]&gt;], [&lt;tbl_df[10 x 2]&gt;], [&lt;tbl_df[10 x 2]&gt;]…</code></pre>
</div>
</div>
</section>
<section id="extracting-dates" class="level2">
<h2 class="anchored" data-anchor-id="extracting-dates">Extracting dates</h2>
<p>All of this is to access the dates in the split and check that the splits has done what I want it to do. we use map_dbl this time to get the date (we have to reconvert it to a date though)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create our 2 simple functions to check the dates </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>get_start_date <span class="ot">&lt;-</span> <span class="cf">function</span>(x){ <span class="fu">min</span>(x<span class="sc">$</span>index) }</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>get_end_date <span class="ot">&lt;-</span> <span class="cf">function</span>(x){ <span class="fu">max</span>(x<span class="sc">$</span>index) }</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>ts_df_dates <span class="ot">&lt;-</span> ts_df <span class="sc">|&gt;</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">start_train_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(train, get_start_date)), </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">end_train_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(train, get_end_date)), </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">start_test_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(validation, get_start_date)), </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">end_test_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(validation, get_end_date))) <span class="sc">|&gt;</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>splits)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(ts_df_dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 73
Columns: 7
$ id               &lt;chr&gt; "Slice01", "Slice02", "Slice03", "Slice04", "Slice05"…
$ train            &lt;list&gt; [&lt;tbl_df[1000 x 2]&gt;], [&lt;tbl_df[1000 x 2]&gt;], [&lt;tbl_df…
$ validation       &lt;list&gt; [&lt;tbl_df[10 x 2]&gt;], [&lt;tbl_df[10 x 2]&gt;], [&lt;tbl_df[10 …
$ start_train_date &lt;date&gt; 2001-01-02, 2001-04-04, 2001-07-06, 2001-10-11, 2002…
$ end_train_date   &lt;date&gt; 2004-12-27, 2005-03-30, 2005-06-29, 2005-09-29, 2005…
$ start_test_date  &lt;date&gt; 2005-01-27, 2005-04-29, 2005-08-01, 2005-10-31, 2006…
$ end_test_date    &lt;date&gt; 2005-02-09, 2005-05-12, 2005-08-12, 2005-11-11, 2006…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># checking the dates </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(ts_df_dates <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>train, <span class="sc">-</span>validation))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  id      start_train_date end_train_date start_test_date end_test_date
  &lt;chr&gt;   &lt;date&gt;           &lt;date&gt;         &lt;date&gt;          &lt;date&gt;       
1 Slice68 2018-01-19       2022-01-06     2022-02-08      2022-02-22   
2 Slice69 2018-04-23       2022-04-08     2022-05-11      2022-05-24   
3 Slice70 2018-07-24       2022-07-13     2022-08-12      2022-08-25   
4 Slice71 2018-10-23       2022-10-12     2022-11-11      2022-11-25   
5 Slice72 2019-01-28       2023-01-13     2023-02-15      2023-03-01   
6 Slice73 2019-04-30       2023-04-18     2023-05-18      2023-06-01   </code></pre>
</div>
</div>
</section>
</section>
<section id="solving-our-problem" class="level1">
<h1>Solving our problem</h1>
<p>Between training size, validation size, skip size, lag size and number of cross-validation samples, some values have to vary and some have to be constant.<br>
Here is what we decided for our problem:</p>
<p>The training size will vary and the rest will be constant.</p>
<p>Constant:</p>
<ul>
<li>number of cross-validation samples: 50</li>
<li>size of validation sample: 20% of the size of the df. We’ll divide that by 50.</li>
<li>skip between training samples = 63 (3 months)</li>
<li>lag before starting testing = 21 (1 month)</li>
</ul>
<p>A problem can arise when the training set becomes too small for appropriate training for the chosen machine learning algorithm. This can happen because the whole dataset is not big enough to start with. In this case, we’ll then <em>size down</em> the skip time in order to have at least 500 training observations to work with. The alternative would have been to reduce the number of the cross-validation samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ticker <span class="ot">&lt;-</span> <span class="st">'HACK'</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">create_cv_data</span>(ticker) </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>get_start_date <span class="ot">&lt;-</span> <span class="cf">function</span>(x){ <span class="fu">min</span>(x<span class="sc">$</span>index) }</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>get_end_date <span class="ot">&lt;-</span> <span class="cf">function</span>(x){ <span class="fu">max</span>(x<span class="sc">$</span>index) }</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>min_size_training <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>number_of_samples <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>skippy <span class="ot">&lt;-</span> <span class="dv">63</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>laggy <span class="ot">&lt;-</span> <span class="dv">21</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get the size of the df we are using. </span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>validation_size <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(df) <span class="sc">*</span> <span class="fl">0.2</span> <span class="sc">/</span> number_of_samples) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>training_size <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df) <span class="sc">-</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  (skippy <span class="sc">*</span> (number_of_samples <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">-</span> </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  (laggy <span class="sc">+</span> validation_size) <span class="sc">-</span> <span class="dv">49</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (training_size <span class="sc">&lt;</span> <span class="dv">500</span>) {</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  training_size <span class="ot">&lt;-</span> min_size_training</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  skippy <span class="ot">&lt;-</span> <span class="fu">floor</span>((<span class="fu">nrow</span>(df) <span class="sc">-</span> validation_size <span class="sc">-</span> laggy <span class="sc">-</span> min_size_training) <span class="sc">/</span> number_of_samples) </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  training_size <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df) <span class="sc">-</span> (skippy <span class="sc">*</span> (number_of_samples <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">-</span> (laggy <span class="sc">+</span> validation_size) <span class="sc">-</span> <span class="dv">49</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#training_size &lt;- 517</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>time_slices2 <span class="ot">&lt;-</span> <span class="fu">rolling_origin</span>(df, </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                              <span class="at">initial =</span> training_size, <span class="at">assess =</span> validation_size <span class="sc">+</span> laggy, </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                              <span class="at">lag =</span> <span class="sc">-</span>laggy, <span class="at">skip =</span> skippy, </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                              <span class="at">cumulative =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">train =</span> <span class="fu">map</span>(splits, training), </span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">validation =</span> <span class="fu">map</span>(splits, testing)) <span class="sc">|&gt;</span> </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">start_train_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(train, get_start_date)), </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>         <span class="at">end_train_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(train, get_end_date)), </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">start_test_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(validation, get_start_date)), </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">end_test_date =</span> <span class="fu">as_date</span>(<span class="fu">map_dbl</span>(validation, get_end_date))) <span class="sc">|&gt;</span> </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>splits)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(skippy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 32</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(time_slices2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 50
Columns: 7
$ id               &lt;chr&gt; "Slice01", "Slice02", "Slice03", "Slice04", "Slice05"…
$ train            &lt;list&gt; [&lt;tbl_df[528 x 2]&gt;], [&lt;tbl_df[528 x 2]&gt;], [&lt;tbl_df[5…
$ validation       &lt;list&gt; [&lt;tbl_df[9 x 2]&gt;], [&lt;tbl_df[9 x 2]&gt;], [&lt;tbl_df[9 x 2…
$ start_train_date &lt;date&gt; 2014-11-12, 2014-12-31, 2015-02-19, 2015-04-08, 2015…
$ end_train_date   &lt;date&gt; 2016-12-15, 2017-02-03, 2017-03-23, 2017-05-10, 2017…
$ start_test_date  &lt;date&gt; 2017-01-19, 2017-03-08, 2017-04-25, 2017-06-12, 2017…
$ end_test_date    &lt;date&gt; 2017-01-31, 2017-03-20, 2017-05-05, 2017-06-22, 2017…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(time_slices2 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>train, <span class="sc">-</span>validation))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  id      start_train_date end_train_date start_test_date end_test_date
  &lt;chr&gt;   &lt;date&gt;           &lt;date&gt;         &lt;date&gt;          &lt;date&gt;       
1 Slice45 2020-08-20       2022-09-23     2022-10-25      2022-11-04   
2 Slice46 2020-10-07       2022-11-09     2022-12-12      2022-12-22   
3 Slice47 2020-11-23       2022-12-28     2023-01-31      2023-02-10   
4 Slice48 2021-01-12       2023-02-15     2023-03-20      2023-03-30   
5 Slice49 2021-03-02       2023-04-04     2023-05-05      2023-05-17   
6 Slice50 2021-04-19       2023-05-22     2023-06-23      2023-07-06   </code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>